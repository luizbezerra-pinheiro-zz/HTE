---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

###################
#RHC Example
```{r}
#install packages
install.packages("tableone")
install.packages("Matching")
```

```{r}
#load packages
library(tableone)
library(MASS)
library(Matching)
library(MatchIt)
```

```{r}
getwd()
df = read.csv("amelia_comp_dataset.csv", na.strings = c("NA", "ND", "NF", "NR","") )
```

```{r}
outcome_variable_name <- "Y"
treatment_variable_name <- "W"
covariate_names <- c("Trauma.center", "SBP.ph","DBP.ph", "HR.ph", "Shock.index.ph",   "Delta.shock.index", "Cristalloid.volume",   "Colloid.volume", "HemoCue.init","Delta.hemoCue", "SpO2.ph.min", "Vasopressor.therapy", "AIS.external", "Cardiac.arrest.ph" )


all_variables_names <- c(outcome_variable_name, treatment_variable_name, covariate_names)
variables_without_treatment =  c(outcome_variable_name, covariate_names)
names(df)[names(df) == "Tranexamic.acid"] <- "W"
names(df)[names(df) == "Death"] <- "Y"
df<- df[, which(names(df) %in% all_variables_names)]


#view data
#df[covariate_names]
```



#treatment variables is swang1
#x variables that we will use
#cat1: primary disease category
#age
#sex
#meanbp1: mean blood pressure


```{r}
#look at a table 1
table1<- CreateTableOne(vars=covariate_names, strata=treatment_variable_name, data=df, test=FALSE)
## include standardized mean difference (SMD)
print(table1,smd=TRUE)
```


############################################
#do greedy matching on Mahalanobis distance
############################################

```{r}
greedymatch<-Match(Tr=df$W, M=1, X=df[covariate_names], replace=FALSE)
matched<-df[unlist(greedymatch[c("index.treated","index.control")]), ]


#get table 1 for matched data with standardized differences
matchedtab1<- CreateTableOne(vars=covariate_names, strata=treatment_variable_name, data=matched, test=FALSE)
## include standardized mean difference (SMD)
print(matchedtab1,smd=TRUE)

```


```{r}
#outcome analysis
y_trt<-matched$Y[matched$W==1]
y_con<-matched$Y[matched$W==0]

#pairwise difference
diffy<-y_trt-y_con

#paired t-test
t.test(diffy)

#McNemar test
table(y_trt,y_con)

mcnemar.test(matrix(c(288,81,172,145),2,2))
```








