---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 
```{r}
getwd()
```

```{r}
df <- read.csv("tabela_amelia5.csv", na.strings = c("NA", "ND", "NF", "NR","")  )
outcome_variable_name <- "Y"
treatment_variable_name <- "W"
 # covariate_names <-c("Numéro de centre",	"Age du patient (ans)",	"Sexe",	"BMI"	,	"Casque",	"Gants",	"Éjection du véhicule",	"Passager décédé dans le même véhicule", "Chute", "Amputation"	,"Fracas du bassin"	,"Brulûre","Surface corporelle brulée",	"Annoncé comme instable	ASA-PS", "Traitement anticoagulant",	"Traitement antiagrégants"	,"Glasgow initial","Glasgow moteur initial",	"Anomalie pupillaire (Pré-hospitalier)",	"Suspicion d atteinte neurologique à l examen	Mannitol / SSH", "Arrêt cardio-respiratoire (massage)",	"Pression Artérielle Systolique (PAS) à l arrivée du SMUR","Pression Artérielle Diastolique (PAD) à l arrivée du SMUR",	"Fréquence cardiaque (FC) à l arrivée du SMUR",	"Pression Artérielle Systolique (PAS) minimum",	"Pression Artérielle Diastolique (PAD) minimum",	"Fréquence cardiaque (FC) maximum",	"Lactates pré-hospitalier"	,"Cristalloïdes",	"Colloïdes",	"Hémocue initial",	"Hémocue, à l arrivée hôpital par équipe hôpital",	"Delta Hémocue	Catécholamines	SpO2 min", "Score de Glasgow en phase hospitalière",	"Glasgow moteur",	"Anomalie pupillaire (Phase hospitalière)"	,"FC en phase hospitalière",	"Pression Artérielle Systolique - PAS",	"Pression Artérielle Diastolique - PAD")
covariate_names <- c("Numéro de centre",	"Age du patient (ans)",	"Sexe",
                     "Glasgow initial","Glasgow moteur initial",	"Anomalie pupillaire (Pré-hospitalier)")
  covariate_names <- c("Numéro de centre",	"Age du patient (ans)",	"Sexe",	"BMI", "Fracas du bassin"	,"Brulûre","Surface corporelle brulée",	"Annoncé comme instable	ASA-PS", "Traitement anticoagulant",	"Traitement antiagrégants"	,"Glasgow initial","Glasgow moteur initial",	"Anomalie pupillaire (Pré-hospitalier)")
```
```{r}
df <- read.csv("tabela_amelia5.csv", na.strings = c("NA", "ND", "NF", "NR","")  )
outcome_variable_name <- "Y"
treatment_variable_name <- "W"
covariate_names <- c("Trauma.center",	"Anticoagulant.therapy","Antiplatelet.therapy",	"GCS.init",
"GCS.motor.init","Pupil.anomaly.ph","Osmotherapy.ph",	"Improv.anomaly.osmo","Cardiac.arrest.ph","SBP.ph","DBP.ph",	  "HR.ph",	"SBP.ph.min",	"DBP.ph.min",	"HR.ph.max",	"Cristalloid.volume",	"Colloid.volume","HemoCue.init","Delta.hemoCue","Vasopressor.therapy",	"SpO2.ph.min",	"Medcare.time.ph",	"GCS",	"GCS.motor",	"Pupil.anomaly",	"TCD.PI.max",	"FiO2",	"Neurosurgery.day0",	"IGS.II",	"Temperature.min",	"W",	"TBI",	"Osmotherapy",	"IICP",	"EVD",	"Decompressive.craniectomy",	"Y",	"AIS.head",	"AIS.face",	"AIS.external",	"ISS",	"Shock.index.ph",	"Delta.shock.index")

```




```{r}
df <- read.csv("tabela_amelia5.csv", na.strings = c("NA", "ND", "NF", "NR","")  )
outcome_variable_name <- "Y"
treatment_variable_name <- "W"
covariate_names <- c("Trauma.center",	"Anticoagulant.therapy",	"GCS.init",
                     "GCS.motor.init","Pupil.anomaly.ph",	"HemoCue.init","Delta.hemoCue", "Delta.shock.index", "ISS")

head(df)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.
```{r}
library(dplyr)       # Data manipulation (0.8.0.1)

library(fBasics)     # Summary statistics (3042.89)

library(corrplot)    # Correlations (0.84)

library(psych)       # Correlation p-values (1.8.12)

library(grf)         # Generalized random forests (0.10.2)

library(rpart)       # Classification and regression trees, or CART (4.1-13)

library(rpart.plot)  # Plotting trees (3.0.6)

library(treeClust)   # Predicting leaf position for causal trees (1.1-7)

library(car)         # linear hypothesis testing for causal tree (3.0-2)

library(devtools)    # Install packages from github (2.0.1)

library(readr)       # Reading csv files (1.3.1)

library(tidyr)       # Database operations (0.8.3)

library(tibble)      # Modern alternative to data frames (2.1.1)

library(knitr)       # RMarkdown (1.21)

library(kableExtra)  # Prettier RMarkdown (1.0.1)

library(ggplot2)     # general plotting tool (3.1.0)

library(haven)       # read stata files (2.0.0)

library(aod)         # hypothesis testing (1.3.1)

library(evtree)      # evolutionary learning of globally optimal trees (1.0-7)

library(causalTree)

library(causalToolbox)

```

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
```{r}
all_variables_names <- c(outcome_variable_name, treatment_variable_name, covariate_names)
#dfselect<- df[, which(names(df) %in% all_variables_names)]
df<- df[, which(names(df) %in% all_variables_names)]


#dfsansna <- na.omit(df)
df <- na.omit(df)
#df <- data.frame(lapply(df, function(x) as.numeric(as.character(x))))
train_fraction <- 0.80  # Use train_fraction % of the dataset to train our models
n <- dim(df)[1]

train_idx <- sample.int(n, replace=F, size=floor(n*train_fraction))

df_train <- df[train_idx,]

df_test <- df[-train_idx,]

head(df)
```

```{r}
split_size <- floor(nrow(df_train) * 0.5)
split_idx <- sample(nrow(df_train), replace=FALSE, size=split_size)

# Make the splits
df_split <- df_train[split_idx,]
df_est <- df_train[-split_idx,]
```


```{r}
fmla_ct <- paste("Y ~", paste(covariate_names, collapse = " + "))
fmla_ct
```


```{r}
library(causalTree)
library(causalToolbox)
ct_unpruned <- honest.causalTree(
   formula = fmla_ct,            # Define the model
  data=df_split,              # Subset used to create tree structure
  est_data=df_est,            # Which data set to use to estimate effects

  treatment=df_split$W,       # Splitting sample treatment variable
  est_treatment=df_est$W,     # Estimation sample treatment variable

  split.Rule="CT",            # Define the splitting option
  cv.option="TOT",            # Cross validation options

  split.Honest=TRUE,          # Use honesty when splitting
  cv.Honest=TRUE,             # Use honesty when performing cross-validation

  minsize=25,                 # Min. number of treatment and control cases in each leaf
  HonestSampleSize=nrow(df_est)) # Num obs used in estimation after building the tree
```
```{r}
rpart.plot(ct_unpruned)
```



```{r}

Y <- df[, which(names(df) %in% outcome_variable_name)]
W <- df[, which(names(df) %in% treatment_variable_name)]

x_covariate_names <- c("Trauma.center", "GCS.init",
                     "GCS.motor.init","HemoCue.init","Delta.hemoCue", "Delta.shock.index", "ISS")
X <- df[, which(names(df) %in% x_covariate_names)]



X <- data.frame(lapply(X, function(x) as.numeric(as.character(x))))
y_forest <- regression_forest(X, Y)
y_hat <- predict(y_forest)$predictions # wtf is predictions???

w_forest <- regression_forest(X, W)
w_hat <- predict(w_forest)$predictions

cf_raw <- causal_forest(X, Y, W,
                        Y.hat = y_hat, W.hat = w_hat)

varimp <- variable_importance(cf_raw)
selected_id <- which(varimp > mean(varimp))
cf <- causal_forest(X[,selected_id], Y, W,
                    Y.hat = y_hat, W.hat = w_hat,
                    tune.parameters = TRUE)
tau_hat <- predict(cf)$predictions

head(tau_hat)
```


```{r}
ATE <- average_treatment_effect(cf)
paste( " 9 5 % CI for the ATE : " , round ( ATE [1] , 3 ) ,
" +/ - " , round ( qnorm (0.975) * ATE [2] , 3 ))
```
```{r}
hist(tau_hat)
```


```{r}
high_effect <- tau_hat > median(tau_hat)
ate_high <- average_treatment_effect(cf, subset = high_effect)
ate_low <- average_treatment_effect(cf, subset = !high_effect)
paste( " 9 5 % CI for the ATE : " , round ( ate_high[1] - ate_low[1] , 3 ) ,
" +/ - " , round ( qnorm (0.975) * sqrt(ate_high[2]^2 + ate_low[2]^2) , 3 ))

```


```{r}
```


```{r}
```

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
